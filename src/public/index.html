<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Huella</title>
    <link href="css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #f8f9fa;
        }

        .container {
            margin-top: 50px;
        }

        .modal-content {
            padding: 20px;
        }

        .form-control {
            margin-bottom: 15px;
        }
    </style>
</head>

<body>
    <div class="container">
        <form method="POST" id="login-form">
            <h5 class="modal-title">Iniciar Sesión</h5>
            <br>
            <!-- Campo de nombre de usuario -->
            <div class="mb-3">
                <label for="username" class="form-label">Nombre de Usuario</label>
                <input type="text" class="form-control" name="username" placeholder="Nombre de usuario" required
                    aria-label="Nombre de usuario">
            </div>
            <!-- Campo de contraseña -->
            <div class="mb-3">
                <label for="password" class="form-label">Contraseña</label>
                <input type="password" class="form-control" name="password" placeholder="Contraseña" required
                    aria-label="Contraseña">
            </div>
            <!-- Botón de inicio de sesión -->
            <div class="d-grid">
                <button type="submit" class="btn btn-primary" aria-label="Iniciar sesión">
                    Iniciar Sesión
                </button>
            </div>
        </form>

        <div id="main-content" class="card shadow p-4" style="display: none;">
            <div class="position-relative text-center mb-4">
                <h1 class="mb-0">Bienvenido, <span id="username"></span></h1>
            </div>
            <div class="border rounded mx-auto" style="border-color: #cccccc; border-width: 2px; max-width: 415px;">
                <h3 class="text-center mb-4">Acciones disponibles</h3>
                <div class="text-center mb-4">
                    <button class="btn btn-dark" id="forzar-cerradura" style="margin-right: 10px;">
                        Forzar cerradura
                    </button>
                    <!-- Botón para abrir el modal de agregar huella -->
                    <button type="button" class="btn btn-success"
                        style="background-color: #0dd40d; border-color: #0dd40d;border-radius: 10px;margin-left: 10px;"
                        data-bs-toggle="modal" data-bs-target="#addDataModal" aria-label="Agregar huella">
                        Agregar Huella
                    </button>
                </div>
            </div>
            <div class="d-grid col-4 mx-auto" style="margin-top: 10px;">
                <!-- Botón para abrir el modal de modificar huella -->
                <button type="button" class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#editDataModal"
                    aria-label="Modificar huella">
                    Opciones Avanzadas
                </button>
            </div>
            <h3 class="text-center mt-5">Datos recibidos de Cliente:</h3>
            <div class="text-center">
                <!-- Sección de datos recibidos -->
                <div class="card mx-auto shadow p-4" style="max-width: 500px;">
                    <div id="datos-cliente" class="text-center">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Cargando...</span>
                        </div>
                        <p>Esperando datos...</p>
                    </div>
                </div>
            </div>
            <button type="submit" id="logoutButton" class="btn btn-danger" aria-label="Cerrar sesión">
                Cerrar sesión
            </button>
        </div>

        <!-- Modal para agregar datos -->
        <div class="modal fade" id="addDataModal" tabindex="-1" aria-labelledby="addDataModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="addDataModalLabel">Agregar Huella</h5>
                        <button type="button" id="btn-close-agregar" class="btn-close" data-bs-dismiss="modal"
                            aria-label="Cerrar"></button>
                    </div>
                    <div class="modal-body">
                        <form method="POST" id="add-data-form">
                            <!-- Campo de nombre de huella -->
                            <div class="mb-3">
                                <label for="nombre" class="form-label">Nombre de huella</label>
                                <input type="text" class="form-control" name="nombre" placeholder="Nombre de huella"
                                    required aria-label="Nombre de huella">
                            </div>
                            <!-- Botón de agregar huella -->
                            <div class="d-grid">
                                <button type="submit" class="btn btn-success" aria-label="Agregar huella">
                                    Agregar Huella
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal para modificar datos -->
        <div class="modal fade" id="editDataModal" tabindex="-1" aria-labelledby="editDataModalLabel"
            aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="editDataModalLabel">Modificar Huella</h5>
                        <button type="button" id="btn-close-modificar" class="btn-close" data-bs-dismiss="modal"
                            aria-label="Cerrar"></button>
                    </div>
                    <div class="modal-body">
                        <!-- Campo de nombre de huella -->
                        <div class="mb-3">
                            <label for="nombre" class="form-label">Nombre de huella</label>
                            <input type="text" class="form-control" name="nombre" placeholder="Nombre de huella"
                                id="nombreEdit" required aria-label="Nombre de huella">
                        </div>
                        <div class="mb-4">
                            <button type="button" class="btn btn-success" style="margin-right: 50px;"
                                aria-label="Sobreescribir huella" id="sobreescribirButton">
                                Sobreescribir huella
                            </button>
                            <button type="button" class="btn btn-warning" style="margin-left: 50px;"
                                aria-label="Eliminar huella" id="eliminarButton">
                                Eliminar Huella
                            </button>
                        </div>
                        <div class="d-grid" style="margin-top: 10px;">
                            <button type="button" class="btn btn-danger"
                                aria-label="Vaciar toda la database (todas las huellas)" id="vaciarButton">
                                Vaciar toda la database (todas las huellas)
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script src="js/bootstrap.bundle.min.js"></script>
    <script src="js/sweetalert2.js"></script>
    <script src="js/socket.io.min.js"></script>
    <script>
        const socket = io();

        socket.on('enviarAlerta', (data) => {
            Swal.fire({
                title: data.message,
                icon: data.success ? 'success' : 'error',
                confirmButtonText: 'Aceptar'
            });
        });

        socket.on('loggedIn', (username) => {
            // Mostrar contenedor principal
            document.getElementById('main-content').style.display = 'block';
            // Ocultar formulario de login
            document.getElementById('login-form').style.display = 'none';
            document.getElementById('username').textContent = username;
        });

        socket.on('loggedOut', () => {
            // Ocultar contenedor principal
            document.getElementById('main-content').style.display = 'none';
            // Mostrar formulario de login
            document.getElementById('login-form').style.display = 'block';
            document.getElementById('username').textContent = '';
        });

        socket.on('added', () => {
            document.getElementById('btn-close-agregar').click();
            const handleKeyPress = (e) => {
                if (e.key === 'Escape') {
                    e.preventDefault();
                }
            };
            Swal.fire({
                title: 'Cargando...',
                text: 'Esperando confirmacion',
                icon: 'info',
                allowEscapeKey: false,
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading();
                    document.addEventListener('keydown', handleKeyPress);
                },
                willClose: () => {
                    document.removeEventListener('keydown', handleKeyPress);
                }
            });
        });

        socket.on('huellaConfirmada', () => {
            Swal.close();
        });

        socket.on('modified', (huella) => {
            document.getElementById('btn-close-modificar').click();
        });

        socket.on('datosCliente', (data) => {
            let textoHtml = `<ul class="list-group">`;
            data.forEach(item => {
                // Crear un objeto Date a partir de la fecha recibida
                const actividadDate = new Date(item.actividad);
                // Formatear la fecha en español
                const fechaFormateada = actividadDate.toLocaleDateString('es-AR', {
                    weekday: 'long',
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit',
                    hour12: false // Para usar el formato 24 horas
                });
                textoHtml += `
                    <li class="list-group-item">
                        <strong>Nombre:</strong> ${item.nombre}<br>
                        <strong>Huella:</strong> ${item.huella != null ? item.huella : 'Esperando confirmacion'}<br>
                        <strong>Actividad:</strong> ${fechaFormateada}
                    </li>`;
                if (item.huella == null) {
                    const handleKeyPress = (e) => {
                        if (e.key === 'Escape') {
                            e.preventDefault();
                        }
                    };
                    Swal.fire({
                        title: 'Cargando...',
                        text: 'Esperando confirmacion',
                        icon: 'info',
                        allowEscapeKey: false,
                        allowOutsideClick: false,
                        didOpen: () => {
                            Swal.showLoading();
                            document.addEventListener('keydown', handleKeyPress);
                        },
                        willClose: () => {
                            document.removeEventListener('keydown', handleKeyPress);
                        }
                    });
                }
            });
            textoHtml += `</ul>`;
            document.getElementById('datos-cliente').innerHTML = textoHtml;
        });

        // Evento de envío del formulario de login
        document.getElementById('login-form').addEventListener('submit', (e) => {
            e.preventDefault();
            socket.emit('login', Object.fromEntries((new FormData(e.target))));
        });

        document.getElementById('logoutButton').addEventListener('click', () => {
            socket.emit('logout');
        });

        // Evento de envío del formulario de agregar datos
        document.getElementById('add-data-form').addEventListener('submit', (e) => {
            e.preventDefault();
            socket.emit('add', Object.fromEntries((new FormData(e.target))));
        });

        // Evento de envío del formulario de eliminar datos
        document.getElementById('eliminarButton').addEventListener('click', () => {
            socket.emit('delete', { nombre: document.getElementById('nombreEdit').value });
        });

        document.getElementById('sobreescribirButton').addEventListener('click', () => {
            socket.emit('sobreescribir', { nombre: document.getElementById('nombreEdit').value });
        });

        document.getElementById('vaciarButton').addEventListener('click', () => {
            Swal.fire({
                title: "Estas seguro?",
                text: "No se puede revertir esto!",
                icon: "warning",
                showCancelButton: true,
                confirmButtonColor: "#3085d6",
                cancelButtonColor: "#d33",
                cancelButtonText: "No, cancelar!",
                confirmButtonText: "Si, borrar todo!"
            }).then((result) => {
                if (result.isConfirmed) {
                    socket.emit('vaciar', { nombre: document.getElementById('nombreEdit').value });
                }
            });
        });

        // Evento de envío del formulario de forzar cerradura
        document.getElementById('forzar-cerradura').addEventListener('click', () => {
            socket.emit('forzarCerradura', true);
        });
    </script>
</body>

</html>